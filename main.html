<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資産管理アプリ | Asset Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter & Noto Sans JP/SC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', 'Noto Sans SC', sans-serif;
        }
        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .lang-btn-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
        }
        /* (修正) スピナー非表示 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800" data-lang-key="appTitle">資産管理アプリ</h1>
                <p class="text-gray-600 mt-2" data-lang-key="appSubtitle">あなたのお金の流れをシンプルに可視化します。</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="lang-ja" class="px-3 py-1 text-sm rounded-md border transition-colors duration-200">日本語</button>
                <button id="lang-zh" class="px-3 py-1 text-sm rounded-md border transition-colors duration-200">中文</button>
            </div>
        </header>

        <!-- Privacy Notice -->
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-lg" role="alert">
            <p class="font-bold" data-lang-key="privacyTitle">プライバシーについて</p>
            <p data-lang-key="privacyBody">入力されたすべてのデータは、お使いのブラウザのローカルストレージにのみ保存されます。サーバーに送信されたり、第三者と共有されることはありません。</p>
        </div>

        <!-- Dashboard (修正: フォントサイズ調整) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Assets -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h3 id="total-assets-label" class="text-lg font-semibold text-gray-500" data-lang-key="totalAssets">総資産</h3>
                <p id="total-assets" class="text-2xl xl:text-3xl font-bold text-gray-800 mt-2">
                    <span id="total-assets-jpy">¥0</span>
                    <span id="total-assets-cny-wrapper" class="text-lg xl:text-xl font-semibold text-gray-600">
                        + <span id="total-assets-cny">¥0</span> (CNY)
                    </span>
                </p>
            </div>
            <!-- Total Income -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h3 id="total-income-label" class="text-lg font-semibold text-gray-500" data-lang-key="totalIncome">累計収入</h3>
                <p id="total-income" class="text-2xl xl:text-3xl font-bold text-green-600 mt-2">
                    <span id="total-income-jpy">¥0</span>
                    <span id="total-income-cny-wrapper" class="text-lg xl:text-xl font-semibold text-gray-600">
                        + <span id="total-income-cny">¥0</span> (CNY)
                    </span>
                </p>
            </div>
            <!-- Total Expense -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h3 id="total-expense-label" class="text-lg font-semibold text-gray-500" data-lang-key="totalExpense">累計支出</h3>
                <p id="total-expense" class="text-2xl xl:text-3xl font-bold text-red-600 mt-2">
                    <span id="total-expense-jpy">¥0</span>
                    <span id="total-expense-cny-wrapper" class="text-lg xl:text-xl font-semibold text-gray-600">
                        + <span id="total-expense-cny">¥0</span> (CNY)
                    </span>
                </p>
            </div>
            <!-- Net Worth -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h3 id="net-worth-label" class="text-lg font-semibold text-gray-500" data-lang-key="netWorth">純資産</h3>
                <p id="net-worth" class="text-2xl xl:text-3xl font-bold text-blue-600 mt-2">
                    <span id="net-worth-jpy">¥0</span>
                    <span id="net-worth-cny-wrapper" class="text-lg xl:text-xl font-semibold text-gray-600">
                        + <span id="net-worth-cny">¥0</span> (CNY)
                    </span>
                </p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Input Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold mb-6" data-lang-key="dataEntry">データ入力</h2>
                <form id="entry-form" class="space-y-6">
                    <div>
                        <label for="entry-type" class="block text-sm font-medium text-gray-700" data-lang-key="entryType">種類</label>
                        <select id="entry-type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm">
                            <option value="income" data-lang-key="typeIncome">収入</option>
                            <option value="expense" data-lang-key="typeExpense">支出</option>
                            <option value="deposit" data-lang-key="typeDeposit">預金残高</option>
                        </select>
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700" data-lang-key="date">日付</label>
                        <input type="date" id="date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" required>
                        <p class="mt-1 text-xs text-gray-500" data-lang-key="dateHelp">カレンダーアイコンから過去の日付も選択できます。</p>
                    </div>
                   
                    <!-- Simplified Amount/Currency Input -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="amount" class="block text-sm font-medium text-gray-700" data-lang-key="amount">金額</label>
                            <!-- (修正) type="text" と inputmode="numeric" でカンマ区切りに対応 -->
                            <input type="text" inputmode="numeric" id="amount" data-lang-placeholder-key="amountPlaceholder" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                             <label for="currency" class="block text-sm font-medium text-gray-700" data-lang-key="currency">通貨</label>
                            <select id="currency" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm">
                                <option value="JPY">JPY</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>
                    </div>
                    <!-- End Simplified Input -->

                    <div>
                        <label for="memo" class="block text-sm font-medium text-gray-700" data-lang-key="memoLabel">メモ (任意)</label>
                        <textarea id="memo" rows="3" data-lang-placeholder-key="memoPlaceholder" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <!-- (修正) 常に口座セレクタを表示 -->
                    <div id="account-selector-wrapper">
                        <label for="account-selector" class="block text-sm font-medium text-gray-700" data-lang-key="account">口座</label>
                        <select id="account-selector" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm"></select>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition" data-lang-key="recordButton">記録する</button>
                </form>
                <div class="mt-6 space-y-3">
                     <button id="open-settings-modal" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition" data-lang-key="settingsButton">銀行口座の設定</button>
                     <button id="open-interest-modal" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition" data-lang-key="interestButton">利率計算ツール</button>
                     <button id="open-exchange-modal" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700 transition" data-lang-key="exchangeButton">為替レート記録</button>
                </div>
            </div>

            <!-- Right: Chart & History -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4" data-lang-key="assetChartTitle">資産推移グラフ</h2>
                   
                    <!-- Chart Rate Controller -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4 flex flex-col sm:flex-row gap-3 items-center">
                        <label for="chart-exchange-rate" class="block text-sm font-medium text-gray-700 whitespace-nowrap" data-lang-key="chartRateLabel">グラフ用レート:</label>
                        <input type="number" step="0.01" id="chart-exchange-rate" data-lang-placeholder-key="chartRatePlaceholder" class="block w-full sm:w-auto flex-grow py-2 px-3 border border-gray-300 rounded-md shadow-sm">
                        <button id="apply-rate-button" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition" data-lang-key="applyButton">適用</button>
                        <button id="clear-rate-button" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition" data-lang-key="clearButton">クリア</button>
                    </div>
                   
                    <!-- (新規) Chart Display Toggle -->
                    <div id="chart-toggle-wrapper" class="bg-gray-50 p-4 rounded-lg mb-6 flex flex-wrap gap-x-6 gap-y-3 items-center justify-center">
                        <span class="text-sm font-medium text-gray-700" data-lang-key="chartToggleLabel">グラフ表示切替:</span>
                        <div class="flex items-center">
                            <input id="toggle-deposits" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                            <label for="toggle-deposits" class="ml-2 block text-sm text-gray-900" data-lang-key="chartToggleDeposits">預金残高</label>
                        </div>
                        <div class="flex items-center">
                            <input id="toggle-income" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <label for="toggle-income" class="ml-2 block text-sm text-gray-900" data-lang-key="chartToggleIncome">収入</label>
                        </div>
                        <div class="flex items-center">
                            <input id="toggle-expense" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="toggle-expense" class="ml-2 block text-sm text-gray-900" data-lang-key="chartToggleExpense">支出</label>
                        </div>
                    </div>
                    <!-- End Chart Display Toggle -->
                   
                    <canvas id="asset-chart"></canvas>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4" data-lang-key="historyTitle">全履歴</h2>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="historyDate">日付</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="historyType">種類</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="historyAmount">金額</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="historyAccount">口座</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="historyMemo">メモ</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="historyAction">操作</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Settings, Interest, Exchange) -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"><div class="absolute inset-0 modal-backdrop"></div><div class="bg-white rounded-2xl shadow-xl w-full max-w-md m-4 p-8 z-10"><h2 class="text-2xl font-bold mb-6" data-lang-key="settingsTitle">銀行口座の設定</h2><form id="settings-form" class="space-y-6"><div><label class="block text-sm font-medium text-gray-700" data-lang-key="account1">口座 1</label><div class="flex items-center space-x-2 mt-1"><input type="text" id="account-name-1" data-lang-placeholder-key="bankNamePlaceholder" class="flex-grow py-2 px-3 border border-gray-300 rounded-md shadow-sm"><input type="color" id="account-color-1" class="w-12 h-10 p-1 border border-gray-300 rounded-md cursor-pointer"></div></div><div><label class="block text-sm font-medium text-gray-700" data-lang-key="account2">口座 2</label><div class="flex items-center space-x-2 mt-1"><input type="text" id="account-name-2" data-lang-placeholder-key="bankNamePlaceholder" class="flex-grow py-2 px-3 border border-gray-300 rounded-md shadow-sm"><input type="color" id="account-color-2" class="w-12 h-10 p-1 border border-gray-300 rounded-md cursor-pointer"></div></div><div><label class="block text-sm font-medium text-gray-700" data-lang-key="account3">口座 3</label><div class="flex items-center space-x-2 mt-1"><input type="text" id="account-name-3" data-lang-placeholder-key="bankNamePlaceholder" class="flex-grow py-2 px-3 border border-gray-300 rounded-md shadow-sm"><input type="color" id="account-color-3" class="w-12 h-10 p-1 border border-gray-300 rounded-md cursor-pointer"></div></div><div class="flex justify-end space-x-4 pt-4"><button type="button" id="close-settings-modal" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition" data-lang-key="closeButton">閉じる</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition" data-lang-key="saveButton">保存</button></div></form></div></div>
    <div id="interest-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"><div class="absolute inset-0 modal-backdrop"></div><div class="bg-white rounded-2xl shadow-xl w-full max-w-md m-4 p-8 z-10"><h2 class="text-2xl font-bold mb-6" data-lang-key="interestTitle">利率計算ツール (年利)</h2><form id="interest-form" class="space-y-4"><div><label for="start-balance" class="block text-sm font-medium text-gray-700" data-lang-key="startBalance">期間開始時の残高</label><input type="number" id="start-balance" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="end-balance" class="block text-sm font-medium text-gray-700" data-lang-key="endBalance">期間終了時の残高</label><input type="number" id="end-balance" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="net-deposit" class="block text-sm font-medium text-gray-700" data-lang-key="netDeposit">期間中の入金額 (利子を除く)</label><input type="number" id="net-deposit" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="period" class="block text-sm font-medium text-gray-700" data-lang-key="periodMonths">期間(ヶ月)</label><input type="number" id="period" value="12" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></div><button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700 transition" data-lang-key="calculateButton">計算</button></form><div id="interest-result" class="mt-6 text-center bg-gray-100 p-4 rounded-lg hidden"><p class="text-lg font-semibold" data-lang-key="interestResultTitle">計算された年利:</p><p id="interest-rate-result" class="text-3xl font-bold text-teal-700"></p></div><div class="text-right mt-6"><button type="button" id="close-interest-modal" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition" data-lang-key="closeButton">閉じる</button></div></div></div>
    <div id="exchange-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"><div class="absolute inset-0 modal-backdrop"></div><div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl m-4 p-8 z-10"><h2 class="text-2xl font-bold mb-6" data-lang-key="exchangeTitle">為替レート記録 (JPY ⇄ CNY)</h2><form id="exchange-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6"><div><label for="exchange-date" class="block text-sm font-medium text-gray-700" data-lang-key="date">日付</label><input type="date" id="exchange-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" required></div><div><label for="exchange-jpy" class="block text-sm font-medium text-gray-700" data-lang-key="jpyAmount">支払った日本円 (JPY)</label><input type="number" id="exchange-jpy" placeholder="10000" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" required></div><div><label for="exchange-cny" class="block text-sm font-medium text-gray-700" data-lang-key="cnyAmount">受け取った中国元 (CNY)</label><input type="number" id="exchange-cny" placeholder="500" step="0.01" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" required></div><div class="md:col-span-3"><button type="submit" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700 transition" data-lang-key="recordButton">記録する</button></div></form><h3 class="text-xl font-bold mb-4" data-lang-key="historyTitle">履歴</h3><div class="max-h-64 overflow-y-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-lang-key="historyDate">日付</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-lang-key="jpyAmount">日本円 (JPY)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-lang-key="cnyAmount">中国元 (CNY)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-lang-key="exchangeRate">レート (1 JPY)</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase" data-lang-key="historyAction">操作</th></tr></thead><tbody id="exchange-history-body" class="bg-white divide-y divide-gray-200"></tbody></table></div><div class="text-right mt-6"><button type="button" id="close-exchange-modal" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition" data-lang-key="closeButton">閉じる</button></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Translation Dictionary (修正) ---
    const translations = {
        ja: {
            appTitle: "資産管理アプリ", appSubtitle: "あなたのお金の流れをシンプルに可視化します。", privacyTitle: "プライバシーについて", privacyBody: "入力されたすべてのデータは、お使いのブラウザのローカルストレージにのみ保存されます。サーバーに送信されたり、第三者と共有されることはありません。",
            totalAssets: "総資産", totalIncome: "累計収入", totalExpense: "累計支出", netWorth: "純資産",
            totalAssetsConverted: "総資産 (JPY換算)", totalIncomeConverted: "累計収入 (JPY換算)", totalExpenseConverted: "累計支出 (JPY換算)", netWorthConverted: "純資産 (JPY換算)",
            dataEntry: "データ入力", entryType: "種類", typeIncome: "収入", typeExpense: "支出", typeDeposit: "預金残高",
            date: "日付", dateHelp: "カレンダーアイコンから過去の日付も選択できます。",
            amount: "金額", amountPlaceholder: "例: 300,000", currency: "通貨",
            memoLabel: "メモ (任意)", memoPlaceholder: "例: 中国渡航のため", account: "口座",
            recordButton: "記録する", settingsButton: "銀行口座の設定", interestButton: "利率計算ツール", exchangeButton: "為替レート記録",
            assetChartTitle: "資産推移グラフ",
            chartRateLabel: "グラフ用レート:", chartRatePlaceholder: "1 CNY = ? JPY", applyButton: "適用", clearButton: "クリア",
            chartToggleLabel: "グラフ表示切替:", chartToggleDeposits: "預金残高", chartToggleIncome: "収入", chartToggleExpense: "支出", // 新規
            historyTitle: "全履歴",
            historyDate: "日付", historyType: "種類", historyAmount: "金額", historyAccount: "口座", historyMemo: "メモ", historyAction: "操作",
            historyEmpty: "履歴がありません。", historyDelete: "削除",
            settingsTitle: "銀行口座の設定", account1: "口座 1", account2: "口座 2", account3: "口座 3", bankNamePlaceholder: "銀行名",
            closeButton: "閉じる", saveButton: "保存",
            interestTitle: "利率計算ツール (年利)", startBalance: "期間開始時の残高", endBalance: "期間終了時の残高", netDeposit: "期間中の入金額 (利子を除く)", periodMonths: "期間(ヶ月)", calculateButton: "計算", interestResultTitle: "計算された年利:",
            confirmDelete: "この履歴を削除しますか？", chartIncome: "月間収入", chartExpense: "月間支出", chartBalance: "残高",
            exchangeTitle: "為替レート記録 (JPY ⇄ CNY)", jpyAmount: "日本円 (JPY)", cnyAmount: "中国元 (CNY)", exchangeRate: "レート (1 JPY)", exchangeHistoryEmpty: "両替履歴がありません。"
        },
        zh: {
            appTitle: "资产管理应用", appSubtitle: "简单地可视化您的资金流向。", privacyTitle: "关于隐私", privacyBody: "您输入的所有数据仅保存在您浏览器的本地存储中。它不会被发送到服务器或与任何第三方共享。",
            totalAssets: "总资产", totalIncome: "累计收入", totalExpense: "累计支出", netWorth: "净资产",
            totalAssetsConverted: "总资产 (折合JPY)", totalIncomeConverted: "累计收入 (折合JPY)", totalExpenseConverted: "累计支出 (折合JPY)", netWorthConverted: "净资产 (折合JPY)",
            dataEntry: "数据录入", entryType: "类型", typeIncome: "收入", typeExpense: "支出", typeDeposit: "存款余额",
            date: "日期", dateHelp: "您可以从日历图标中选择过去的日期。",
            amount: "金额", amountPlaceholder: "例如: 300,000", currency: "货币",
            memoLabel: "备注 (可选)", memoPlaceholder: "例如: 为去中国出差", account: "账户",
            recordButton: "记录", settingsButton: "银行账户设置", interestButton: "利率计算器", exchangeButton: "汇率记录",
            assetChartTitle: "资产趋势图",
            chartRateLabel: "图表汇率:", chartRatePlaceholder: "1 CNY = ? JPY", applyButton: "应用", clearButton: "清除",
            chartToggleLabel: "图表显示切换:", chartToggleDeposits: "存款余额", chartToggleIncome: "收入", chartToggleExpense: "支出", // 新規
            historyTitle: "全部历史记录",
            historyDate: "日期", historyType: "类型", historyAmount: "金额", historyAccount: "账户", historyMemo: "备注", historyAction: "操作",
            historyEmpty: "暂无历史记录。", historyDelete: "删除",
            settingsTitle: "银行账户设置", account1: "账户 1", account2: "账户 2", account3: "账户 3", bankNamePlaceholder: "银行名称",
            closeButton: "关闭", saveButton: "保存",
            interestTitle: "利率计算器 (年利率)", startBalance: "期初余额", endBalance: "期末余额", netDeposit: "期间存款金额 (不含利息)", periodMonths: "期间(月)", calculateButton: "计算", interestResultTitle: "计算出的年利率:",
            confirmDelete: "您确定要删除此条记录吗？", chartIncome: "月收入", chartExpense: "月支出", chartBalance: "余额",
            exchangeTitle: "汇率记录 (JPY ⇄ CNY)", jpyAmount: "日元 (JPY)", cnyAmount: "人民币 (CNY)", exchangeRate: "汇率 (1 JPY)", exchangeHistoryEmpty: "暂无兑换记录。"
        }
    };

    let currentLang = 'ja';

    const switchLanguage = (lang) => {
        if (!translations[lang]) return;
        currentLang = lang;
        localStorage.setItem('assetTrackerLang', lang);

        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (translations[lang][key]) {
                if (!el.dataset.originalLangKey) {
                    el.dataset.originalLangKey = key;
                }
                el.textContent = translations[lang][key];
            }
        });

        document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => {
            const key = el.getAttribute('data-lang-placeholder-key');
            if (translations[lang][key]) el.placeholder = translations[lang][key];
        });

        document.getElementById('lang-ja').classList.toggle('lang-btn-active', lang === 'ja');
        document.getElementById('lang-zh').classList.toggle('lang-btn-active', lang === 'zh');
       
        // (修正) renderChart を直接呼ぶのではなく、renderUIを呼ぶ
        const currentRate = parseFloat(chartRateInput.value) || 0;
        updateUI(currentRate);
    };

    // DOM Elements
    const entryForm = document.getElementById('entry-form');
    const dateInput = document.getElementById('date');
    const amountInput = document.getElementById('amount');
    const currencySelect = document.getElementById('currency');
    const memoInput = document.getElementById('memo');
    const accountSelector = document.getElementById('account-selector');
    const entryTypeSelect = document.getElementById('entry-type');
    const accountSelectorWrapper = document.getElementById('account-selector-wrapper');
    const historyTableBody = document.getElementById('history-table-body');
    const settingsModal = document.getElementById('settings-modal');
    const interestModal = document.getElementById('interest-modal');
    const exchangeModal = document.getElementById('exchange-modal');
    const exchangeHistoryBody = document.getElementById('exchange-history-body');
    const chartRateInput = document.getElementById('chart-exchange-rate');
    const applyRateButton = document.getElementById('apply-rate-button');
    const clearRateButton = document.getElementById('clear-rate-button');

    // (新規) Chart Toggle Elements
    const chartToggleWrapper = document.getElementById('chart-toggle-wrapper');
    const toggleDeposits = document.getElementById('toggle-deposits');
    const toggleIncome = document.getElementById('toggle-income');
    const toggleExpense = document.getElementById('toggle-expense');

    // Dashboard Elements
    const totalAssetsEl = { label: document.getElementById('total-assets-label'), jpy: document.getElementById('total-assets-jpy'), cny: document.getElementById('total-assets-cny'), wrapper: document.getElementById('total-assets-cny-wrapper') };
    const totalIncomeEl = { label: document.getElementById('total-income-label'), jpy: document.getElementById('total-income-jpy'), cny: document.getElementById('total-income-cny'), wrapper: document.getElementById('total-income-cny-wrapper') };
    const totalExpenseEl = { label: document.getElementById('total-expense-label'), jpy: document.getElementById('total-expense-jpy'), cny: document.getElementById('total-expense-cny'), wrapper: document.getElementById('total-expense-cny-wrapper') };
    const netWorthEl = { label: document.getElementById('net-worth-label'), jpy: document.getElementById('net-worth-jpy'), cny: document.getElementById('net-worth-cny'), wrapper: document.getElementById('net-worth-cny-wrapper') };

    let assetChart;

    let data = {
        accounts: [ { id: 1, name: '銀行A', color: '#4F46E5' }, { id: 2, name: '銀行B', color: '#10B981' }, { id: 3, name: '銀行C', color: '#F59E0B' } ],
        entries: [],
        exchanges: []
    };

    function initialize() {
        const savedLang = localStorage.getItem('assetTrackerLang') || 'ja';
        const savedRate = localStorage.getItem('assetTrackerChartRate') || '';
        chartRateInput.value = savedRate;
       
        // (新規) Load saved chart toggles
        toggleDeposits.checked = localStorage.getItem('toggleDeposits') !== 'false'; // Default true
        toggleIncome.checked = localStorage.getItem('toggleIncome') === 'true'; // Default false
        toggleExpense.checked = localStorage.getItem('toggleExpense') === 'true'; // Default false

        loadData();
        setupEventListeners();
        setDefaultDate();
        switchLanguage(savedLang); // This will call updateUI
    }

    function loadData() {
        const savedData = localStorage.getItem('assetTrackerData');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            data.accounts = parsedData.accounts || data.accounts;
            data.entries = (parsedData.entries || []).map(entry => {
                if (!entry.currency) entry.currency = 'JPY';
                return {
                    id: entry.id, type: entry.type, date: entry.date,
                    amount: entry.amount, currency: entry.currency,
                    memo: entry.memo, accountId: entry.accountId
                };
            });
            data.exchanges = parsedData.exchanges || [];
        }
    }

    function saveData() {
        localStorage.setItem('assetTrackerData', JSON.stringify(data));
    }

    function setDefaultDate() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const today = now.toISOString().slice(0,10);
        dateInput.value = today;
        document.getElementById('exchange-date').value = today;
    }

    // --- Main Update Function ---
    function updateUI(chartRate = 0) {
        updateAccountSelectors();
        updateDashboard(chartRate);
        renderHistory();
        // (修正) Pass toggle state to renderChart
        renderChart(chartRate, {
            deposits: toggleDeposits.checked,
            income: toggleIncome.checked,
            expense: toggleExpense.checked
        });
        renderExchangeHistory();
    }
   
    function updateAccountSelectors() {
        accountSelector.innerHTML = '';
        data.accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = acc.id;
            option.textContent = acc.name;
            accountSelector.appendChild(option);
        });

        data.accounts.forEach(acc => {
            document.getElementById(`account-name-${acc.id}`).value = acc.name;
            document.getElementById(`account-color-${acc.id}`).value = acc.color;
        });
    }

    function getConvertedAmount(amount, currency, rate) {
        if (currency === 'CNY' && rate > 0) {
            return amount * rate;
        }
        if (currency === 'JPY') {
            return amount;
        }
        return 0;
    }

    function updateDashboard(chartRate) {
        let totalIncome = { jpy: 0, cny: 0 };
        let totalExpense = { jpy: 0, cny: 0 };
        let latestDeposits = {};
        data.accounts.forEach(acc => { latestDeposits[acc.id] = { jpy: 0, cny: 0 }; });

        // (修正) 預金残高の計算ロジックを修正
        // 日付順にソートして、最新の残高を追跡
        const sortedEntries = [...data.entries].sort((a, b) => new Date(a.date) - new Date(b.date));
       
        sortedEntries.forEach(entry => {
            const currencyKey = entry.currency.toLowerCase();
            if (entry.type === 'income') {
                totalIncome[currencyKey] += entry.amount;
            } else if (entry.type === 'expense') {
                totalExpense[currencyKey] += entry.amount;
            } else if (entry.type === 'deposit') {
                if (latestDeposits[entry.accountId]) {
                    // (修正) 口座の通貨ごとに最新の残高を保持する
                    if(entry.currency === 'JPY') latestDeposits[entry.accountId].jpy = entry.amount;
                    if(entry.currency === 'CNY') latestDeposits[entry.accountId].cny = entry.amount;
                }
            }
        });

        let totalAssets = { jpy: 0, cny: 0 };
        data.accounts.forEach(acc => {
            totalAssets.jpy += latestDeposits[acc.id].jpy;
            totalAssets.cny += latestDeposits[acc.id].cny;
        });
       
        let netWorth = {
            jpy: totalIncome.jpy - totalExpense.jpy,
            cny: totalIncome.cny - totalExpense.cny
        };

        const dashboardData = [
            { el: totalAssetsEl, data: totalAssets, key: 'totalAssets' },
            { el: totalIncomeEl, data: totalIncome, key: 'totalIncome' },
            { el: totalExpenseEl, data: totalExpense, key: 'totalExpense' },
            { el: netWorthEl, data: netWorth, key: 'netWorth' }
        ];

        dashboardData.forEach(item => {
            if (chartRate > 0) {
                const totalJPY = item.data.jpy + (item.data.cny * chartRate);
                item.el.jpy.textContent = `¥${totalJPY.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                item.el.wrapper.style.display = 'none';
                item.el.label.textContent = translations[currentLang][`${item.key}Converted`];
            } else {
                item.el.jpy.textContent = `¥${item.data.jpy.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                item.el.cny.textContent = `¥${item.data.cny.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                item.el.wrapper.style.display = item.data.cny === 0 ? 'none' : 'inline';
                item.el.label.textContent = translations[currentLang][item.key];
            }
        });
    }

    function renderHistory() {
        historyTableBody.innerHTML = '';
        const sortedEntries = [...data.entries].sort((a, b) => new Date(b.date) - new Date(a.date));

        if(sortedEntries.length === 0) {
             historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">${translations[currentLang].historyEmpty}</td></tr>`;
             return;
        }

        sortedEntries.forEach(entry => {
            const row = document.createElement('tr');
            const typeKey = { income: 'typeIncome', expense: 'typeExpense', deposit: 'typeDeposit' }[entry.type];
            const typeText = translations[currentLang][typeKey];
            const typeColor = { income: 'text-green-600', expense: 'text-red-600', deposit: 'text-blue-600' }[entry.type];
            // (修正) 収入でも口座名を表示
            const account = data.accounts.find(a => a.id === entry.accountId);
            const amountText = entry.currency === 'CNY'
                ? `¥ ${entry.amount.toLocaleString()} (CNY)`
                : `¥ ${entry.amount.toLocaleString()} (JPY)`;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">${entry.date}</td>
                <td class="px-6 py-4 whitespace-nowrap"><span class="font-semibold ${typeColor}">${typeText}</span></td>
                <td class="px-6 py-4 whitespace-nowrap font-semibold">${amountText}</td>
                <!-- (修正) 収入でも口座名を表示。見つからない場合は N/A -->
                <td class="px-6 py-4 whitespace-nowrap">${account ? account.name : 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${entry.memo || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button class="text-red-600 hover:text-red-900" data-id="${entry.id}">${translations[currentLang].historyDelete}</button>
                </td>`;
            historyTableBody.appendChild(row);
        });
    }

    function renderExchangeHistory() {
        exchangeHistoryBody.innerHTML = '';
        const sortedExchanges = [...data.exchanges].sort((a, b) => new Date(b.date) - new Date(a.date));
        if (sortedExchanges.length === 0) {
            exchangeHistoryBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">${translations[currentLang].exchangeHistoryEmpty}</td></tr>`;
            return;
        }
        sortedExchanges.forEach(ex => {
            const rate = ex.jpy > 0 ? (ex.cny / ex.jpy).toFixed(4) : 0;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap">${ex.date}</td>
                <td class="px-4 py-4 whitespace-nowrap">¥ ${ex.jpy.toLocaleString()}</td>
                <td class="px-4 py-4 whitespace-nowrap">¥ ${ex.cny.toLocaleString()}</td>
                <td class="px-4 py-4 whitespace-nowrap font-semibold text-indigo-600">${rate}</td>
                <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button class="text-red-600 hover:text-red-900" data-id="${ex.id}">${translations[currentLang].historyDelete}</button>
                </td>
            `;
            exchangeHistoryBody.appendChild(row);
        });
    }

    // (修正) グラフ切り替え機能を追加
    function renderChart(chartRate, toggles) {
        const ctx = document.getElementById('asset-chart').getContext('2d');
        const allMonths = [...new Set(data.entries.map(e => e.date.substring(0, 7)))].sort();

        if (allMonths.length === 0) {
            if(assetChart) assetChart.destroy();
            return;
        }
       
        const datasets = [];

        // 収入グラフ
        if (toggles.income) {
            const incomeData = allMonths.map(m =>
                data.entries
                    .filter(e => e.type === 'income' && e.date.startsWith(m))
                    .reduce((s, e) => s + getConvertedAmount(e.amount, e.currency, chartRate), 0)
            );
            datasets.push({ label: translations[currentLang].chartIncome, data: incomeData, borderColor: 'rgba(16, 185, 129, 0.8)', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3, });
        }

        // 支出グラフ
        if (toggles.expense) {
            const expenseData = allMonths.map(m =>
                data.entries
                    .filter(e => e.type === 'expense' && e.date.startsWith(m))
                    .reduce((s, e) => s + getConvertedAmount(e.amount, e.currency, chartRate), 0)
            );
            datasets.push({ label: translations[currentLang].chartExpense, data: expenseData, borderColor: 'rgba(239, 68, 68, 0.8)', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3, });
        }

        // 預金残高グラフ
        if (toggles.deposits) {
            data.accounts.forEach(account => {
                let lastBalances = { jpy: 0, cny: 0 }; // 口座ごとにリセット
                const depositData = allMonths.map(month => {
                    // (修正) その月までのすべてのデータを考慮する
                    const entriesUpToMonth = data.entries
                        .filter(e => e.type === 'deposit' && e.accountId === account.id && e.date.substring(0, 7) <= month)
                        .sort((a,b) => new Date(b.date) - new Date(a.date)); // 日付の降順ソート

                    const latestJPY = entriesUpToMonth.find(d => d.currency === 'JPY');
                    const latestCNY = entriesUpToMonth.find(d => d.currency === 'CNY');
                   
                    // 月をまたいで最新の残高を維持
                    if (latestJPY) lastBalances.jpy = latestJPY.amount;
                    if (latestCNY) lastBalances.cny = latestCNY.amount;

                    return getConvertedAmount(lastBalances.jpy, 'JPY', chartRate) + getConvertedAmount(lastBalances.cny, 'CNY', chartRate);
                });
                datasets.push({
                    label: `${account.name} ${translations[currentLang].chartBalance}`,
                    data: depositData,
                    borderColor: account.color, backgroundColor: 'transparent', tension: 0.3,
                });
            });
        }

        if (assetChart) assetChart.destroy();
       
        assetChart = new Chart(ctx, {
            type: 'line', data: { labels: allMonths, datasets: datasets },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: (v) => '¥' + v.toLocaleString() } } },
                plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label||''}: ¥${c.parsed.y.toLocaleString()}` } } }
            }
        });
    }

    // (新規) カンマ区切りフォーマッター
    function formatAmountInput(e) {
        let value = e.target.value;
        // 小数点と数字以外（カンマなど）を除去
        let numericValue = value.replace(/[^0-9.]/g, '');
       
        const parts = numericValue.split('.');
        let integerPart = parts[0];
        let decimalPart = parts[1];

        // 整数部分をカンマ区切りに
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        // 小数点がある場合は、それを維持 (小数点以下2桁まで)
        if (decimalPart !== undefined) {
            e.target.value = `${integerPart}.${decimalPart.slice(0, 2)}`;
        } else {
            e.target.value = integerPart;
        }
    }

    function setupEventListeners() {
        document.getElementById('lang-ja').addEventListener('click', () => switchLanguage('ja'));
        document.getElementById('lang-zh').addEventListener('click', () => switchLanguage('zh'));

        // (修正) 収入の場合でも口座セレクタを隠すロジックを削除
        // entryTypeSelect.addEventListener('change', () => { ... });

        // (新規) 金額入力にカンマ区切りリスナーを追加
        amountInput.addEventListener('input', formatAmountInput);

        entryForm.addEventListener('submit', (e) => {
            e.preventDefault();
           
            // (修正) カンマを除去してから数値に変換
            const amountString = amountInput.value.replace(/,/g, '');
           
            data.entries.push({
                id: Date.now(),
                type: entryTypeSelect.value,
                date: dateInput.value,
                amount: parseFloat(amountString) || 0, // カンマ除去後の値を使用
                currency: currencySelect.value,
                memo: memoInput.value.trim(),
                accountId: parseInt(accountSelector.value) // (修正) 常に口座IDを取得
            });
            saveData();
            const currentRate = parseFloat(chartRateInput.value) || 0;
            updateUI(currentRate);
            entryForm.reset();
            setDefaultDate();
        });

        historyTableBody.addEventListener('click', (e) => {
            if (e.target.dataset.id) {
                if (confirm(translations[currentLang].confirmDelete)) {
                    data.entries = data.entries.filter(entry => entry.id !== parseInt(e.target.dataset.id));
                    saveData();
                    const currentRate = parseFloat(chartRateInput.value) || 0;
                    updateUI(currentRate);
                }
            }
        });

        // (新規) Chart Toggle Listeners
        const chartToggles = [toggleDeposits, toggleIncome, toggleExpense];
        chartToggles.forEach(toggle => {
            toggle.addEventListener('change', () => {
                // Save state
                localStorage.setItem(toggle.id, toggle.checked);
                // Re-render chart
                const currentRate = parseFloat(chartRateInput.value) || 0;
                updateUI(currentRate);
            });
        });

        // Chart Rate Listeners
        applyRateButton.addEventListener('click', () => {
            const rate = parseFloat(chartRateInput.value) || 0;
            localStorage.setItem('assetTrackerChartRate', rate > 0 ? rate : '');
            updateUI(rate);
        });

        clearRateButton.addEventListener('click', () => {
            chartRateInput.value = '';
            localStorage.removeItem('assetTrackerChartRate');
            updateUI(0);
        });
       
        // Modals
        document.getElementById('open-settings-modal').addEventListener('click', () => settingsModal.classList.remove('hidden'));
        document.getElementById('close-settings-modal').addEventListener('click', () => settingsModal.classList.add('hidden'));
        document.getElementById('settings-form').addEventListener('submit', (e) => { e.preventDefault(); data.accounts.forEach(acc => { acc.name = document.getElementById(`account-name-${acc.id}`).value || `Bank ${acc.id}`; acc.color = document.getElementById(`account-color-${acc.id}`).value; }); saveData(); const currentRate = parseFloat(chartRateInput.value) || 0; updateUI(currentRate); settingsModal.classList.add('hidden'); });
        document.getElementById('open-interest-modal').addEventListener('click', () => interestModal.classList.remove('hidden'));
        document.getElementById('close-interest-modal').addEventListener('click', () => interestModal.classList.add('hidden'));
        document.getElementById('interest-form').addEventListener('submit', (e) => { e.preventDefault(); const start = parseFloat(document.getElementById('start-balance').value), end = parseFloat(document.getElementById('end-balance').value), netDeposit = parseFloat(document.getElementById('net-deposit').value), period = parseInt(document.getElementById('period').value); const interestEarned = end - start - netDeposit, avgPrincipal = start + (netDeposit / 2); const annualRate = (avgPrincipal > 0) ? (interestEarned / avgPrincipal) * (12 / period) : 0; document.getElementById('interest-rate-result').textContent = `${(annualRate * 100).toFixed(4)} %`; document.getElementById('interest-result').classList.remove('hidden'); });

        // Exchange Modal Listeners
        document.getElementById('open-exchange-modal').addEventListener('click', () => exchangeModal.classList.remove('hidden'));
        document.getElementById('close-exchange-modal').addEventListener('click', () => exchangeModal.classList.add('hidden'));

        document.getElementById('exchange-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newExchange = {
                id: Date.now(),
                date: document.getElementById('exchange-date').value,
                jpy: parseFloat(document.getElementById('exchange-jpy').value),
                cny: parseFloat(document.getElementById('exchange-cny').value)
            };
            data.exchanges.push(newExchange);
            saveData();
            renderExchangeHistory();
            e.target.reset();
            setDefaultDate();
        });

        exchangeHistoryBody.addEventListener('click', (e) => {
            if (e.target.dataset.id) {
                if (confirm(translations[currentLang].confirmDelete)) {
                    data.exchanges = data.exchanges.filter(ex => ex.id !== parseInt(e.target.dataset.id));
                    saveData();
                    renderExchangeHistory();
                }
            }
        });
    }

    initialize();
});
</script>
</body>
</html>